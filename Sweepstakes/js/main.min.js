import*as THREE from"three";import TWEEN from"./tween.module.js";import{TrackballControls}from"./TrackballControls.js";import{CSS3DRenderer,CSS3DObject}from"./CSS3DRenderer.js";function randomRaffleWithoutRemove(e){var t=Math.floor(Math.random()*e[0].length);return e[0][t]}function randomRaffleAndRemove(e){console.log(e);var t=Math.floor(Math.random()*e[0].length),n=(console.log(t),e[0][t]);return console.log("randomRaffleAndRemove 被呼叫了"),console.log(n),e.splice(t,1),n}function maskString(e,t){return e.length<=t?e:e.slice(0,t)+e.slice(t).replace(/./g,"*")}!function(e){var t,n={kitId:"hve4tim",scriptTimeout:3e3,async:!0},o=e.documentElement,a=setTimeout(function(){o.className=o.className.replace(/\bwf-loading\b/g,"")+" wf-inactive"},n.scriptTimeout),l=e.createElement("script"),r=!1,e=e.getElementsByTagName("script")[0];o.className+=" wf-loading",l.src="https://use.typekit.net/"+n.kitId+".js",l.async=!0,l.onload=l.onreadystatechange=function(){if(t=this.readyState,!(r||t&&"complete"!=t&&"loaded"!=t)){r=!0,clearTimeout(a);try{Typekit.load(n)}catch(e){}}},e.parentNode.insertBefore(l,e)}(document);let globalSquareRegion="TC",raffleDataListTC=[],raffleDataListCN=[];$.ajax({type:"GET",url:"RaffleAllTC.json",success:function(e){raffleDataListTC.push(e),init(),animate(),clearInterval(texttime),createSquareAndRotate(800,.02,.05,!1,"TC")},error:function(e){console.log(e)}}),$.ajax({type:"GET",url:"RaffleAllChina.json",success:function(e){raffleDataListCN.push(e)},error:function(e){console.log(e)}});let camera,scene,renderer,controls,prizeObject,objects=[],targets={table:[],sphere:[],helix:[],grid:[]},sphereGroup=new THREE.Group;const buttonRaffleTC=document.getElementById("raffleTC"),buttonRaffleTC2=document.getElementById("raffleTC2"),buttonLotteryTC=document.getElementById("lotteryTC"),buttonStopTC=document.getElementById("stopTC"),buttonOpenTC=document.getElementById("openTC"),buttonRaffleCN=document.getElementById("raffleCN"),buttonLotteryCN=document.getElementById("lotteryCN"),buttonStopCN=document.getElementById("stopCN"),buttonOpenCN=document.getElementById("openCN"),buttonAwardWinner=document.getElementById("AwardWinner"),geometry=new THREE.BoxGeometry(50,50,50),material=new THREE.MeshBasicMaterial({color:65280,transparent:!0,opacity:0});let square=new THREE.Mesh(geometry,material),angle=0,radius=1100,texttime,globalRotate,globalRotatey,globalRotatestop,globaltextsetInterval;function clearAndRebuildDiv(){var e=document.getElementById("container");for(console.log(e.children.length);0<e.children.length;)e.removeChild(e.children[0]);console.log("清除舊的 div 並重新建立新的 div")}function init(){if((camera=new THREE.PerspectiveCamera(40,window.innerWidth/window.innerHeight,1,1e4)).position.z=3e3,scene=new THREE.Scene,localStorage.getItem("非大陸")&&localStorage.getItem("大陸")&&(document.querySelector(".prizeElementTC").style.display="none",document.querySelector(".prizeElementCN").style.display="none"),"TC"===globalSquareRegion){objects=[],sphereGroup=new THREE.Group,console.log("進入TC圓球");for(var e=raffleDataListTC[0].slice(),t=e.length-1;0<t;t--){var n=Math.floor(Math.random()*(t+1)),o=e[t];e[t]=e[n],e[n]=o}var a=e.slice(0,200);for(let e=0;e<a.length;e++){var l=document.createElement("div"),r=e%5+1,r=(l.classList.add("element"+r),l.classList.add("element"),l.style.opacity=.8*Math.random()+.4,document.createElement("div")),r=(r.className="number",r.textContent=e/5+1,document.createElement("div")),r=(r.className="symbol",r.textContent=a[e].Name,l.appendChild(r),document.createElement("div")),r=(r.className="details",r.innerHTML=a[e].UID,l.appendChild(r),new CSS3DObject(l)),l=(r.position.x=4e3*Math.random()-2e3,r.position.y=4e3*Math.random()-2e3,r.position.z=4e3*Math.random()-2e3,scene.add(r),objects.push(r),sphereGroup.add(r),scene.add(sphereGroup),new THREE.Object3D);l.position.x=140*a[e+3]-1330,l.position.y=-180*a[e+4]+990,targets.table.push(l)}}else{objects=[],sphereGroup=new THREE.Group,console.log("進入CN圓球");for(var s=raffleDataListCN[0].slice(),t=s.length-1;0<t;t--){n=Math.floor(Math.random()*(t+1)),o=s[t];s[t]=s[n],s[n]=o}var i=s.slice(0,200);console.log(i);for(let e=0;e<i.length;e++){var c=document.createElement("div"),d=e%5+1,d=(c.classList.add("element"+d),c.classList.add("element"),c.style.opacity=.8*Math.random()+.4,document.createElement("div")),d=(d.className="number",d.textContent=e/5+1,document.createElement("div")),d=(d.className="symbol",d.textContent=i[e].Name,c.appendChild(d),document.createElement("div")),d=(d.className="details",d.innerHTML=i[e].UID,c.appendChild(d),new CSS3DObject(c)),c=(d.position.x=4e3*Math.random()-2e3,d.position.y=4e3*Math.random()-2e3,d.position.z=4e3*Math.random()-2e3,scene.add(d),objects.push(d),sphereGroup.add(d),scene.add(sphereGroup),new THREE.Object3D);c.position.x=140*i[e+3]-1330,c.position.y=-180*i[e+4]+990,targets.table.push(c)}}var m=new THREE.Vector3;for(let e=0,t=objects.length;e<t;e++){var u=Math.acos(2*e/t-1),p=Math.sqrt(t*Math.PI)*u,y=new THREE.Object3D;y.position.setFromSphericalCoords(800,u,p),m.copy(y.position).multiplyScalar(2),y.lookAt(m),targets.sphere.push(y)}(renderer=new CSS3DRenderer).setSize(window.innerWidth,window.innerHeight),document.getElementById("container").appendChild(renderer.domElement),(controls=new TrackballControls(camera,renderer.domElement)).minDistance=500,controls.maxDistance=26e3,controls.addEventListener("change",render),setTimeout(()=>{transform(targets.sphere,2e3,"")},0),window.addEventListener("resize",onWindowResize),document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("wheel",onDocumentMouseWheel,!1)}buttonRaffleTC2.addEventListener("click",function(){globalSquareRegion="TC",clearAndRebuildDiv(),init(),setTimeout(()=>{scatterAndReset(targets.table,700,"TC")},0),clearInterval(texttime),createSquareAndRotate(800,.02,.05,!1,"TC")}),buttonRaffleTC.addEventListener("click",function(){globalSquareRegion="TC",localStorage.getItem("非大陸")?(console.log("15616"),$(".prizeElement").attr("style","visibility: hidden;"),document.querySelectorAll(".Squarediv").forEach(function(e){e.style.visibility="visible"})):console.log("5555"),setTimeout(()=>{scatterAndReset(targets.table,700,"TC")},0),localStorage.getItem("大陸")&&document.querySelector(".first.personnelCN").classList.add("firstnonopacity")}),buttonLotteryTC.addEventListener("click",function(){startSelfSpin(6e3,10,"stopTC"),globaltextsetInterval=100,globalRotate=.03,globalRotatey=.03,globalRotatestop=!1,animateSquareRotate()}),buttonStopTC.addEventListener("click",function(){buttonStopTC.style.display="none",transform(targets.sphere,2e3,"openTC")}),buttonOpenTC.addEventListener("click",function(){globalRotatestop=!0,animateSquareRotate("TC"),buttonOpenTC.style.display="none",localStorage.getItem("非大陸")&&localStorage.getItem("大陸")?console.log("123"):setTimeout(()=>{document.getElementById("raffleTC2").style.display="block"},8e3)}),buttonRaffleCN.addEventListener("click",function(){globalSquareRegion="CN",localStorage.getItem("大陸")?($(".prizeElement").attr("style","visibility: hidden;"),document.querySelectorAll(".Squarediv").forEach(function(e){e.style.visibility="visible"}),setTimeout(()=>{scatterAndReset(targets.table,700,"CN")},0)):(clearAndRebuildDiv(),init(),setTimeout(()=>{scatterAndReset(targets.table,700,"CN")},0),clearInterval(texttime),createSquareAndRotate(800,.02,.05,!1,"CN")),localStorage.getItem("非大陸")&&document.querySelector(".first.personnelTC").classList.add("firstnonopacity")}),buttonLotteryCN.addEventListener("click",function(){startSelfSpin(6e3,10,"stopCN"),globaltextsetInterval=100,globalRotate=.03,globalRotatey=.03,globalRotatestop=!1,animateSquareRotate()}),buttonStopCN.addEventListener("click",function(){buttonStopCN.style.display="none",transform(targets.sphere,2e3,"openCN")}),buttonOpenCN.addEventListener("click",function(){localStorage.getItem("非大陸")&&localStorage.getItem("大陸")?document.getElementById("AwardWinner").style.display="none":setTimeout(()=>{document.getElementById("AwardWinner").style.display="block"},8e3),globalRotatestop=!0,animateSquareRotate("CN"),buttonOpenCN.style.display="none"}),buttonAwardWinner.addEventListener("click",function(){$(".prizeElementTC").addClass("prizeElementLeft"),$(".prizeElementCN").addClass("prizeElementRight"),$(".prizeElement").attr("style","visibility: visible;"),document.querySelectorAll(".Squarediv").forEach(function(e){e.classList.add("firstnonopacity")}),buttonAwardWinner.style.display="none",localStorage.getItem("大陸")&&localStorage.getItem("非大陸")&&(buttonRaffleTC.classList.add("buttonRaffleTC"),buttonRaffleCN.classList.add("buttonRaffleCN"))});const buttonRaffleConfirmTC=document.getElementById("raffleConfirmTC");function RaffleConfirmTC(e){globalSquareRegion="TC",confirm("確定執行操作嗎？")?(clearAndRebuildDiv(),init(),clearInterval(texttime),createSquareAndRotate(800,.02,.05,!1,"TC"),setTimeout(()=>{scatterAndReset(targets.table,700,"TC")},0),buttonLotteryCN.style.display="none",buttonStopCN.style.display="none",buttonOpenCN.style.display="none",buttonLotteryTC.style.display="none",buttonStopTC.style.display="none",buttonOpenTC.style.display="none",buttonAwardWinner.style.display="none"):document.querySelectorAll(".prizeElement").forEach(function(e){e.style.visibility="visible"}),e.stopPropagation()}buttonRaffleConfirmTC.addEventListener("click",RaffleConfirmTC);const buttonRaffleConfirmCN=document.getElementById("raffleConfirmCN");function RaffleConfirmCN(e){globalSquareRegion="CN",confirm("確定執行操作嗎？")?(clearAndRebuildDiv(),init(),clearInterval(texttime),createSquareAndRotate(800,.02,.05,!1,"CN"),setTimeout(()=>{scatterAndReset(targets.table,700,"CN")},0),buttonLotteryCN.style.display="none",buttonStopCN.style.display="none",buttonOpenCN.style.display="none",buttonLotteryTC.style.display="none",buttonStopTC.style.display="none",buttonOpenTC.style.display="none",buttonAwardWinner.style.display="none"):document.querySelectorAll(".prizeElement").forEach(function(e){e.style.visibility="visible"}),e.stopPropagation()}function scatterAndReset(t,n,o){TWEEN.removeAll();for(let e=0;e<objects.length;e++){var a=objects[e];t[e];new TWEEN.Tween(a.position).to({x:4e3*Math.random()-2e3,y:4e3*Math.random()-2e3,z:4e3*Math.random()-2e3},n).easing(TWEEN.Easing.Exponential.InOut).start(),new TWEEN.Tween(a.rotation).to({x:0,y:0,z:0},n).easing(TWEEN.Easing.Exponential.InOut).start()}new TWEEN.Tween(this).to({},2*n).onUpdate(render).start().onComplete(()=>{console.log("Finished scatterAndReset!");var e=document.getElementById("lotteryTC"),t=document.getElementById("lotteryCN");switch(o){case"TC":startSelfSpin(6e3,2,"lotteryTC"),e.style.display="block";break;case"CN":startSelfSpin(6e3,2,"lotteryTC"),t.style.display="block"}});var e=document.getElementById("raffleTC"),l=document.getElementById("raffleTC2");document.getElementById("raffleCN").style.display="none",e.style.display="none",l.style.display="none"}function transform(t,n,a){TWEEN.removeAll();for(let e=0;e<objects.length;e++){var o=objects[e],l=t[e];new TWEEN.Tween(o.position).to({x:l.position.x,y:l.position.y,z:l.position.z},Math.random()*n+n).easing(TWEEN.Easing.Exponential.InOut).start(),new TWEEN.Tween(o.rotation).to({x:l.rotation.x,y:l.rotation.y,z:l.rotation.z},Math.random()*n+n).easing(TWEEN.Easing.Exponential.InOut).start()}new TWEEN.Tween(this).to({},2*n).onUpdate(render).start().onComplete(()=>{var e=document.getElementById("raffleTC"),t=document.getElementById("raffleTC"),n=document.getElementById("openTC"),o=document.getElementById("openCN");switch(console.log("finished tween!"),a){case"openTC":startSelfSpin(6e3,2,""),n.style.display="block";break;case"openCN":startSelfSpin(6e3,2,""),o.style.display="block";break;default:localStorage.getItem("非大陸")&&localStorage.getItem("大陸")?(e.style.display="none",t.style.display="none"):(e.style.display="block",t.style.display="block"),startSelfSpin(6e3,2,"")}})}function createSquareAndRotate(e,t,n,o,a){if(console.log("155"),square){for(scene.remove(square);0<square.children.length;)square.remove(square.children[0]);console.log("清除")}globaltextsetInterval=e,globalRotate=t,globalRotatey=n,globalRotatestop=o,square.position.z=0,scene.add(square);var l=(e,t,n,o,a,l,r,s)=>{var i=document.createElement("div"),r=(i.classList.add("Squarediv"),i.classList.add("hover-effect"),"first"===r&&i.classList.add("first"),"TC"===s&&i.classList.add("personnelTC"),"CN"===s&&i.classList.add("personnelCN"),i.style.backgroundColor=""+l,document.createElement("div")),s=(r.className="dept squareDept ",i.appendChild(r),document.createElement("div")),l=(s.className="namenums squareNamenum ",i.appendChild(s),document.createElement("div")),r=(l.className="namenum squareNamenum ",s.appendChild(l),document.createElement("div")),s=(r.className="symbol squareName ",l.appendChild(r),document.createElement("div")),r=(s.className="details squareUID ",l.appendChild(s),document.createElement("div")),l=(r.className="winbg squareWinbg ",i.appendChild(r),new CSS3DObject(i));return l.position.set(t,n,o),l.rotation.y=a,l};switch(a){case"TC":square.add(l(0,0,0,175,0,"","first","TC"));break;case"CN":square.add(l(0,0,0,175,0,"","first","CN"))}switch(a){case"TC":square.add(l(0,0,0,-175,Math.PI,"#52c187","","TC"));break;case"CN":square.add(l(0,0,0,-175,Math.PI,"#52c187","","CN"))}switch(a){case"TC":square.add(l(0,-175,0,0,-Math.PI/2,"#e86bb0","","TC"));break;case"CN":square.add(l(0,-175,0,0,-Math.PI/2,"#e86bb0","","CN"))}switch(a){case"TC":square.add(l(0,175,0,0,Math.PI/2,"#e56161","","TC"));break;case"CN":square.add(l(0,175,0,0,Math.PI/2,"#e56161","","CN"))}animateSquareRotate();let r=0;texttime=setInterval(function(){square.children.forEach(e=>{let t;t="TC"===globalSquareRegion?randomRaffleWithoutRemove(raffleDataListTC):randomRaffleWithoutRemove(raffleDataListCN);var n=e.element.children[0],o=e.element.children[1].children[0].children[0],e=e.element.children[1].children[0].children[1];n.textContent=t.Dept,o.textContent=t.Name,e.textContent=t.UID}),r++},e),console.log("還在動")}function animateSquareRotate(t){globalRotatestop?(new TWEEN.Tween(square.position).to({x:0,z:1e3},4e3).start(),new TWEEN.Tween(square.rotation).to({y:0},6e3).onComplete(()=>{switch(document.querySelectorAll(".Squarediv").forEach(function(e){e.classList.contains("first")||e.classList.add("firstnonopacity")}),globalRotate=0,clearInterval(texttime),texttime=null,console.log("停止進入"),t){case"TC":{let t=randomRaffleAndRemove(raffleDataListTC);console.log("winnerObj"),console.log(t),console.log(t.Name),document.querySelector(".personnelTC").classList.add("firstadd"),localStorage.setItem("非大陸",`${t.Dept}|${t.Name}|`+t.UID),document.querySelector(".prizeElementTC .department").textContent=""+t.Dept,document.querySelector(".prizeElementTC .name").textContent=""+t.Name,document.querySelector(".prizeElementTC .uid").textContent=""+t.UID,document.querySelector(".personnelTC .dept").textContent=""+t.Dept,document.querySelector(".personnelTC .symbol").textContent=""+t.Name,document.querySelector(".personnelTC .details").textContent=""+t.UID,document.querySelector(".personnelTC .squareDept").style.opacity="1",document.querySelector(".personnelTC .squareDept").style.position="initial";var e=raffleDataListTC.find(e=>raffleDataListTC.Name===t.selectedObjectName);e?console.log(`找到了对象，UID为 ${e.UID}，Dept为 `+e.Dept):console.log("未找到名字为 的对象");break}case"CN":e=randomRaffleAndRemove(raffleDataListTC);document.querySelector(".personnelCN").classList.add("firstadd"),localStorage.setItem("大陸",`${e.Dept}|${e.Name}|`+e.UID),document.querySelector(".prizeElementCN .department").textContent=""+e.Dept,document.querySelector(".prizeElementCN .name").textContent=""+e.Name,document.querySelector(".prizeElementCN .uid").textContent=""+e.UID,document.querySelector(".personnelCN .dept").textContent=""+e.Dept,document.querySelector(".personnelCN .symbol").textContent=""+e.Name,document.querySelector(".personnelCN .details").textContent=""+e.UID,document.querySelector(".personnelCN .squareDept").style.opacity="1",document.querySelector(".personnelCN .squareDept").style.position="initial"}}).start()):(globalRotatestop||requestAnimationFrame(animateSquareRotate),square.position.x=radius*Math.cos(angle),square.position.z=radius*Math.sin(angle),square.rotation.y-=globalRotatey,angle+=globalRotate,TWEEN.update(),renderer.render(scene,camera))}function rotateByGlobalYAxis(e){e.children.forEach(e=>{const t=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI);t.multiply(e.quaternion),new TWEEN.Tween(e.quaternion).to(t,500).onUpdate(()=>{e.quaternion.slerp(t,.1)}).start()})}function showSquareThroughSphere(){new TWEEN.Tween(square.position).to({x:0,y:0,z:0},3e3).onComplete(()=>{}).start()}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight),render()}function animate(){requestAnimationFrame(animate),TWEEN.update(),controls.update()}function render(){renderer.render(scene,camera)}function startSelfSpin(e,t,n){TWEEN.removeAll(),sphereGroup.rotation.y=0;var t={y:Math.PI*t},o=document.getElementById("lotteryTC");let a=document.getElementById("stopTC");var l=document.getElementById("lotteryCN");let r=document.getElementById("stopCN");new TWEEN.Tween(sphereGroup.rotation).to(t,e).onUpdate(render).repeat(1/0).start();switch(console.log(sphereGroup.rotation),n){case"lotteryTC":o.style.display="none";break;case"stopTC":o.style.display="none",setTimeout(()=>{a.style.display="block"},1e3);break;case"stopCN":console.log("123"),l.style.display="none",setTimeout(()=>{r.style.display="block"},1e3)}console.log("Finished startSelfSpin..")}function onMouseMove(e){}function onDocumentMouseWheel(e){}function transformPrize(e,t){var n=new THREE.Vector3(5,5,1e3),o=new THREE.Euler(Math.PI,Math.PI,Math.PI),a=new THREE.Vector3(7,7,7),n=new TWEEN.Tween(e.position).to({x:n.x,y:n.y,z:n.z},t),o=new TWEEN.Tween(e.rotation).to({x:o.x,y:o.y,z:o.z},t),e=new TWEEN.Tween(e.scale).to({x:a.x,y:a.y,z:a.z},t);n.start(),o.start(),e.start()}function zoomIn(){camera.position.z-=100,camera.updateProjectionMatrix(),renderer.render(scene,camera),500<camera.position.z&&requestAnimationFrame(zoomIn)}function zoomOut(e){camera.position.z+=50,camera.updateProjectionMatrix(),renderer.render(scene,camera),camera.position.z<e&&requestAnimationFrame(zoomOut)}buttonRaffleConfirmCN.addEventListener("click",RaffleConfirmCN);